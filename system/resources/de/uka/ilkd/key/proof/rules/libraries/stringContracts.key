\contracts {
  //
  // length
  //
  length {
      \programVariables {
          int result;
          java.lang.String s;
      }
      true ->
      \<{
          result = s.length()@java.lang.String;
      }\>(result = length(content(s)))
      \modifies { result }
      \displayname "length"
  };

  //
  // charAt
  //
  charAtNormal {
      \programVariables {
          char result;
          java.lang.String s;
          int i;
      }
      (i >= 0 & i < length(content(s))) ->
      \<{
          #catchAll(java.lang.Exception exc) {
              result = s.charAt(i)@java.lang.String;
      }}\>(exc = null & result = charAt(i,content(s)))
      \modifies { result }
      \displayname "CharAt Normal"
  };
  
  charAtExc {
      \programVariables {
          char result;
          java.lang.String s;
          int i;
      }
      (i < 0 | i >= length(content(s))) ->
      \<{
          #catchAll(java.lang.Exception exc) {
              result = s.charAt(i)@java.lang.String;
      }}\>(  exc != null
           & java.lang.IndexOutOfBoundsException::instance(exc) = TRUE)
      \modifies {java.lang.IndexOutOfBoundsException.<nextToCreate>,
                 \for java.lang.IndexOutOfBoundsException exc; exc.<created>,
                 \for java.lang.IndexOutOfBoundsException exc; exc.<transient>,
                 \for java.lang.IndexOutOfBoundsException exc; exc.<initialized> }
      \displayname "CharAt Exceptional: IndexOutOfBounds"
  };

  //
  // concat
  //
  concatNormal {
      \programVariables {
          java.lang.String result, s1, s2;
      }
      (s2 != null & length(content(s2)) > 0) ->
      \<{
          result = s1.concat(s2)@java.lang.String;
      }\>(  java.lang.Object::<created>@pre(result) = FALSE
          & result.<created>@(java.lang.Object) = TRUE
          & result != null
          & content(result) = concat(content(s1),content(s2)) )
      \modifies {
                  result,
                  content(result),
                  result.<nextToCreate>@(java.lang.String),
                  result.<created>@(java.lang.Object),
                  result.<initialized>@(java.lang.Object),
                  result.<transient>@(java.lang.Object) }
      \displayname "Concat Normal"
  };
    
  concatNormalLen0 {
      \programVariables {
          java.lang.String result, s1, s2;
      }
      (s2 != null & length(content(s2)) = 0) ->
      \<{
          result = s1.concat(s2)@java.lang.String;
      }\>(result = s1)
      \modifies { result }
      \displayname "Concat Normal"
  };
  
  concatExc {
      \programVariables {
          java.lang.String result, s1, s2;
      }
      (s2 = null) ->
      \<{
          #catchAll(java.lang.Exception exc) {
              result = s1.concat(s2)@java.lang.String;
      }}\>(  exc != null
           & java.lang.NullPointerException::instance(exc) = TRUE)
      \modifies {java.lang.NullPointerException.<nextToCreate>,
                 \for java.lang.NullPointerException exc; exc.<created>,
                 \for java.lang.NullPointerException exc; exc.<transient>,
                 \for java.lang.NullPointerException exc; exc.<initialized> }
      \displayname "Concat Exceptional: Null Pointer"
  };

  //
  // substring
  //
  substringNormal {
      \programVariables {
          java.lang.String result, s;
          int i, j;
      }
      (j>=i & i >= 0 & j <= length(content(s))) ->
      \<{
          result = s.substring(i,j)@java.lang.String;
      }\>(  java.lang.Object::<created>@pre(result) = FALSE
          & result.<created>@(java.lang.Object) = TRUE
          & result != null
          & content(result) = substring(i,j,content(s)))
      \modifies { result,
                  content(result),
                  result.<nextToCreate>@(java.lang.String),
                  result.<created>@(java.lang.Object),
                  result.<initialized>@(java.lang.Object),
                  result.<transient>@(java.lang.Object) }
      \displayname "Substring Normal"
  };

  substringExc {
      \programVariables {
          java.lang.String result, s;
          int i, j;
      }
      (i>j | i<0 | j > length(content(s))) ->
      \<{
          #catchAll(java.lang.Exception exc) {
              result = s.substring(i,j)@java.lang.String;
      }}\>(  exc != null
           & java.lang.IndexOutOfBoundsException::instance(exc) = TRUE)
      \modifies {java.lang.IndexOutOfBoundsException.<nextToCreate>,
                 \for java.lang.IndexOutOfBoundsException exc; exc.<created>,
                 \for java.lang.IndexOutOfBoundsException exc; exc.<transient>,
                 \for java.lang.IndexOutOfBoundsException exc; exc.<initialized> }
      \displayname "Substring Exceptional: IndexOutOfBounds"
  };

  substring2Normal {
      \programVariables {
          java.lang.String result, s;
          int i;
      }
      (i >= 0 & i < length(content(s))) ->
      \<{
          result = s.substring(i)@java.lang.String;
      }\>(  java.lang.Object::<created>@pre(result) = FALSE
          & result.<created>@(java.lang.Object) = TRUE
          & result != null
          & content(result) = substring(i,length(content(s)),content(s)))
      \modifies { result,
                  content(result),
                  result.<nextToCreate>@(java.lang.String),
                  result.<created>@(java.lang.Object),
                  result.<initialized>@(java.lang.Object),
                  result.<transient>@(java.lang.Object) }
      \displayname "Substring Normal"
  };

  substring2Exc {
      \programVariables {
          java.lang.String result, s;
          int i;
      }
      (i<0 | i > length(content(s))) ->
      \<{
          #catchAll(java.lang.Exception exc) {
          result = s.substring(i)@java.lang.String;
      }}\>(  exc != null
           & java.lang.IndexOutOfBoundsException::instance(exc) = TRUE)
      \modifies {java.lang.IndexOutOfBoundsException.<nextToCreate>,
                 \for java.lang.IndexOutOfBoundsException exc; exc.<created>,
                 \for java.lang.IndexOutOfBoundsException exc; exc.<transient>,
                 \for java.lang.IndexOutOfBoundsException exc; exc.<initialized> }
      \displayname "Substring Exceptional: IndexOutOfBounds"
  };

  //
  // compareTo
  //
  compareToNormal {
      \programVariables {
          java.lang.String s1, s2;
          int result;
      }
      (s2 != null) ->
      \<{
          result = s1.compareTo(s2)@java.lang.String;
      }\>( result = \ifEx int i; (  i < length(content(s1))
                                  & i < length(content(s2))
                                  & charAt(i,content(s1))
                                     != charAt(i,content(s2)) )
                        \then (charAt(i,content(s1)) - charAt(i,content(s2)))
                        \else (length(content(s1)) - length(content(s2))) )
      \modifies { result }
      \displayname "compareTo Normal"
  };

  compareToExc {
      \programVariables {
          java.lang.String s1, s2;
          int result;
      }
      (s2 = null) ->
      \<{
          #catchAll(java.lang.Exception exc) {
              result = s1.compareTo(s2)@java.lang.String;
      }}\>(  exc != null
           & java.lang.NullPointerException::instance(exc) = TRUE)
      \modifies {java.lang.NullPointerException.<nextToCreate>,
                 \for java.lang.NullPointerException exc; exc.<created>,
                 \for java.lang.NullPointerException exc; exc.<transient>,
                 \for java.lang.NullPointerException exc; exc.<initialized> }
      \displayname "compareTo Exceptional: Null Pointer"
  };

  //
  // endsWith
  //
  endsWithNormal {
      \programVariables {
          java.lang.String s1, s2;
          boolean result;
      }
      (s2 != null) ->
      \<{
          result = s1.endsWith(s2)@java.lang.String;
      }\>(result = TRUE <-> endsWith(content(s2),content(s1)))
      \modifies { result }
      \displayname "endsWith Normal"
  };

  endsWithExc {
      \programVariables {
          java.lang.String s1, s2;
          boolean result;
      }
      (s2 = null) ->
      \<{
          #catchAll(java.lang.Exception exc) {
              result = s1.endsWith(s2)@java.lang.String;
      }}\>(  exc != null
           & java.lang.NullPointerException::instance(exc) = TRUE)
      \modifies {java.lang.NullPointerException.<nextToCreate>,
                 \for java.lang.NullPointerException exc; exc.<created>,
                 \for java.lang.NullPointerException exc; exc.<transient>,
                 \for java.lang.NullPointerException exc; exc.<initialized> }
      \displayname "endsWith Exceptional: Null Pointer"
  };

  //
  // startsWith
  //
  startsWith1Normal {
      \programVariables {
          java.lang.String s1, s2;
          boolean result;
      }
      (s2 != null) ->
      \<{
          result = s1.startsWith(s2)@java.lang.String;
      }\>(result = TRUE <-> startsWith(content(s2),content(s1)))
      \modifies { result }
      \displayname "startsWith Normal"
  };

  startsWith1Exc {
      \programVariables {
          java.lang.String s1, s2;
          boolean result;
      }
      (s2 = null) ->
      \<{
          #catchAll(java.lang.Exception exc) {
              result = s1.startsWith(s2)@java.lang.String;
      }}\>(  exc != null
           & java.lang.NullPointerException::instance(exc) = TRUE)
      \modifies {java.lang.NullPointerException.<nextToCreate>,
                 \for java.lang.NullPointerException exc; exc.<created>,
                 \for java.lang.NullPointerException exc; exc.<transient>,
                 \for java.lang.NullPointerException exc; exc.<initialized> }
      \displayname "startsWith Exceptional: Null Pointer"
  };

  startsWith2Normal {
      \programVariables {
          java.lang.String s1, s2;
          boolean result;
          int i;
      }
      (s2 != null) ->
      \<{
          result = s1.startsWith(s2, i)@java.lang.String;
      }\>(result = TRUE <-> (  (i >= 0)
                             & (i <= length(content(s1)))
                             & startsWith(content(s2),
                                          substring(i,
                                                    length(content(s1)),
                                                    content(s1))) ))
      \modifies { result }
      \displayname "startsWith Normal"
  };

  startsWith2Exc {
      \programVariables {
          java.lang.String s1, s2;
          boolean result;
          int i;
      }
      (s2 = null) ->
      \<{
          #catchAll(java.lang.Exception exc) {
              result = s1.startsWith(s2, i)@java.lang.String;
      }}\>(  exc != null
           & java.lang.NullPointerException::instance(exc) = TRUE)
      \modifies {java.lang.NullPointerException.<nextToCreate>,
                 \for java.lang.NullPointerException exc; exc.<created>,
                 \for java.lang.NullPointerException exc; exc.<transient>,
                 \for java.lang.NullPointerException exc; exc.<initialized> }
      \displayname "startsWith Exceptional: Null Pointer"
  };

  //
  // replace
  //
  replaceNormal {
      \programVariables {
          java.lang.String s, result;
          char c1, c2;
      }
      true ->
      \<{
          result = s.replace(c1,c2)@java.lang.String;
      }\>(\if (\exists int i; (  i >= 0 
                               & i < length(content(s))
                               & charAt(i,content(s)) = c1))
          \then(  java.lang.Object::<created>@pre(result) = FALSE
                & result.<created>@(java.lang.Object) = TRUE
                & result != null
                & content(result) = replace(c1,c2,content(s)) )
          \else ( result = s ) )
      \modifies { result,
                  content(result),
                  result.<nextToCreate>@(java.lang.String),
                  result.<created>@(java.lang.Object),
                  result.<initialized>@(java.lang.Object),
                  result.<transient>@(java.lang.Object) }
      \displayname "replace Normal"
  };

  //
  // indexOf
  //
  indexOfNormal {
      \programVariables {
          java.lang.String s;
          int charVal;
          int result;
      }
      true ->
      \<{ 
          result = s.indexOf(charVal)@java.lang.String;
      }\>(result = indexOf((jchar)charVal,0,content(s)))
      \modifies { result }
      \displayname "indexOf Normal"
  };

  indexOfFromNormal {
      \programVariables {
          java.lang.String s;
          int charVal, from;
          int result;
      }
      true ->
      \<{
          result = s.indexOf(charVal,from)@java.lang.String;
      }\>(result = indexOf((jchar)charVal,from,content(s)))
      \modifies { result }
      \displayname "indexOf Normal"
  };

  indexOfStringNormal {
      \programVariables {
          java.lang.String s, t;
          int result;
      }
      (t != null) ->
      \<{
          result = s.indexOf(t)@java.lang.String;
      }\>(result = indexOfStr(content(t),0,content(s)))
      \modifies { result }
      \displayname "indexOf Normal"
  };

  indexOfStringExc {
      \programVariables {
          java.lang.String s, t;
          int result;
      }
      (t = null) ->
      \<{
          #catchAll (java.lang.Exception exc) {
              result = s.indexOf(t)@java.lang.String;
      }}\>(  exc != null
           & java.lang.NullPointerException::instance(exc) = TRUE)
      \modifies {java.lang.NullPointerException.<nextToCreate>,
                 \for java.lang.NullPointerException exc; exc.<created>,
                 \for java.lang.NullPointerException exc; exc.<transient>,
                 \for java.lang.NullPointerException exc; exc.<initialized> }
      \displayname "indexOf Exceptional"
  };

  indexOfStringFromNormal {
      \programVariables {
          java.lang.String s, t;
          int result, from;
      }
      (t != null) ->
      \<{
          result = s.indexOf(t, from)@java.lang.String;
      }\>(result = indexOfStr(content(t),from,content(s)))
      \modifies { result }
      \displayname "indexOf Normal"
  };

  indexOfStringFromExc {
      \programVariables {
          java.lang.String s, t;
          int result, from;
      }
      (t = null) ->
      \<{
          #catchAll (java.lang.Exception exc) {
              result = s.indexOf(t,from)@java.lang.String;
      }}\>(  exc != null
           & java.lang.NullPointerException::instance(exc) = TRUE)
      \modifies {java.lang.NullPointerException.<nextToCreate>,
                 \for java.lang.NullPointerException exc; exc.<created>,
                 \for java.lang.NullPointerException exc; exc.<transient>,
                 \for java.lang.NullPointerException exc; exc.<initialized> }
      \displayname "indexOf Exceptional"
  };

  //
  // lastIndexOf
  //
  lastIndexOfNormal {
      \programVariables {
          java.lang.String s;
          int charVal;
          int result;
      }
      true ->
      \<{ 
          result = s.lastIndexOf(charVal)@java.lang.String;
      }\>(result = lastIndexOf((jchar)charVal,
                               length(content(s))-1,content(s)))
      \modifies { result }
      \displayname "lastIndexOf Normal"
  };

  lastIndexOfFromNormal {
      \programVariables {
          java.lang.String s;
          int charVal, from;
          int result;
      }
      true ->
      \<{ 
          result = s.lastIndexOf(charVal,from)@java.lang.String;
      }\>(result = lastIndexOf((jchar)charVal,from,content(s)))
      \modifies { result }
      \displayname "lastIndexOf Normal"
  };

  lastIndexOfStringNormal {
      \programVariables {
          java.lang.String s, t;
          int result;
      }
      (t != null) ->
      \<{
          result = s.lastIndexOf(t)@java.lang.String;
      }\>(result = lastIndexOfStr(content(t),
                                  length(content(s))-1,content(s)))
      \modifies { result }
      \displayname "lastIndexOf Normal"
  };

  lastIndexOfStringExc {
      \programVariables {
          java.lang.String s, t;
          int result;
      }
      (t = null) ->
      \<{
          #catchAll (java.lang.Exception exc) {
              result = s.lastIndexOf(t)@java.lang.String;
      }}\>(  exc != null
           & java.lang.NullPointerException::instance(exc) = TRUE)
      \modifies {java.lang.NullPointerException.<nextToCreate>,
                 \for java.lang.NullPointerException exc; exc.<created>,
                 \for java.lang.NullPointerException exc; exc.<transient>,
                 \for java.lang.NullPointerException exc; exc.<initialized> }
      \displayname "lastIndexOf Exceptional"
  };

  lastIndexOfStringFromNormal {
      \programVariables {
          java.lang.String s, t;
          int result, from;
      }
      (t != null) ->
      \<{
          result = s.lastIndexOf(t, from)@java.lang.String;
      }\>(result = lastIndexOfStr(content(t),from,content(s)))
      \modifies { result }
      \displayname "lastIndexOf Normal"
  };

  lastIndexOfStringFromExc {
      \programVariables {
          java.lang.String s, t;
          int result, from;
      }
      (t = null) ->
      \<{
          #catchAll (java.lang.Exception exc) {
              result = s.lastIndexOf(t,from)@java.lang.String;
      }}\>(  exc != null
           & java.lang.NullPointerException::instance(exc) = TRUE)
      \modifies {java.lang.NullPointerException.<nextToCreate>,
                 \for java.lang.NullPointerException exc; exc.<created>,
                 \for java.lang.NullPointerException exc; exc.<transient>,
                 \for java.lang.NullPointerException exc; exc.<initialized> }
      \displayname "lastIndexOf Exceptional"
  };

  //
  // toString
  //
  toStringNormal {
      \programVariables {
          java.lang.String s, result;
      }
      true ->
      \<{
          result = s.toString()@java.lang.String;
      }\>(result = s)
      \modifies { result }
      \displayname "toString Normal"
  };

  //
  // equals
  //
  equalsNormal {
      \programVariables {
          java.lang.String s;
          java.lang.Object obj;
          boolean result;
      }
      true ->
      \<{
          result = s.equals(obj)@java.lang.String;
      }\>( result = TRUE <-> (  obj != null
          & java.lang.String::instance(obj)= TRUE
          & content(s) = content((java.lang.String)obj) ))
      \modifies { result }
      \displayname "equals"
  };

  //
  // isEmpty
  //
  isEmptyNormal {
      \programVariables {
          java.lang.String s;
          boolean result;
      }
      true ->
      \<{
          result = s.isEmpty()@java.lang.String;
      }\>( result = TRUE <-> content(s) = empty )
      \modifies { result }
      \displayname "isEmpty"
  };

  //
  // copyValueOf
  //
  copyValueOfNormal {
      \programVariables {
          java.lang.String result;
          char[] data;
      }
      (data != null) ->
      \<{
      result = java.lang.String.copyValueOf(data)
                @java.lang.String;
      }\>(   length(content(result)) = data.length
          & \forall int i; ((i >= 0 & i < data.length)
                  -> charAt(i,content(result)) = data[i] )
          & java.lang.Object::<created>@pre(result) = FALSE
          & result.<created>@(java.lang.Object) = TRUE
          & result != null )
      \modifies { result,
                  content(result),
                  result.<nextToCreate>@(java.lang.String),
                  result.<created>@(java.lang.Object),
                  result.<initialized>@(java.lang.Object),
                  result.<transient>@(java.lang.Object) }
      \displayname "copyValueOf Normal"
  };

  copyValueOfExc {
      \programVariables {
          java.lang.String result;
          char[] data;
      }
      (data = null) ->
      \<{
          #catchAll (java.lang.Exception exc) {
              result = java.lang.String.copyValueOf(data)
                        @java.lang.String;
      }}\> (  exc != null
           & java.lang.NullPointerException::instance(exc) = TRUE)
      \modifies {java.lang.NullPointerException.<nextToCreate>,
                 \for java.lang.NullPointerException exc; exc.<created>,
                 \for java.lang.NullPointerException exc; exc.<transient>,
                 \for java.lang.NullPointerException exc; exc.<initialized> }
      \displayname "copyValueOf NullPointer"
  };

  copyValueOfRangeNormal {
      \programVariables {
          java.lang.String result;
          char[] data;
          int offset, count;
      }
      (  data != null 
       & offset >= 0
       & count >= 0
       & offset+count <= data.length)
      ->
      \<{
          result = java.lang.String.copyValueOf(data, offset, count)
                    @java.lang.String;
      }\>(  length(content(result)) = count
          & \forall int i; ((i >= 0 & i < count)
                         -> charAt(i,content(result)) = data[i+offset] )
          & java.lang.Object::<created>@pre(result) = FALSE
          & result.<created>@(java.lang.Object) = TRUE
          & result != null )
      \modifies { result,
                  content(result),
                  result.<nextToCreate>@(java.lang.String),
                  result.<created>@(java.lang.Object),
                  result.<initialized>@(java.lang.Object),
                  result.<transient>@(java.lang.Object) }
      \displayname "copyValueOf Normal"
  };

  copyValueOfRangeExcBounds {
      \programVariables {
          java.lang.String result;
          char[] data;
          int offset, count;
      }
      (  data != null
       & ( offset < 0
          | count < 0
          | offset+count > data.length))
      ->
      \<{
          #catchAll (java.lang.Exception exc) {
              result = java.lang.String.copyValueOf (data,offset,count)
                        @java.lang.String;
      }}\>(  exc != null
           & java.lang.IndexOutOfBoundsException::instance(exc) = TRUE)
      \modifies {java.lang.IndexOutOfBoundsException.<nextToCreate>,
                 \for java.lang.IndexOutOfBoundsException exc; exc.<created>,
                 \for java.lang.IndexOutOfBoundsException exc; exc.<transient>,
                 \for java.lang.IndexOutOfBoundsException exc; exc.<initialized> }
      \displayname "copyValueOf Exceptional"
  };

  copyValueOfRangeExcNull {
      \programVariables {
          java.lang.String result;
          char[] data;
          int offset, count;
      }
      (data = null) ->
      \<{
          #catchAll (java.lang.Exception exc) {
              result = java.lang.String.copyValueOf(data,offset,count)
                        @java.lang.String;
      }}\> (  exc != null
           & java.lang.NullPointerException::instance(exc) = TRUE)
      \modifies{ }
      \displayname "copyValueOf NullPointer"
  };

  //
  // getChars
  //
  getCharsNormal {
      \programVariables {
          java.lang.String s;
          char[] dst;
          int srcBegin, srcEnd, dstBegin;
      }
      (  dst != null
       & srcBegin >= 0
       & srcBegin <= srcEnd
       & srcEnd <= length(content(s))
       & dstBegin >= 0
       & dstBegin+(srcEnd-srcBegin) <= dst.length )
      ->
      \<{
          s.getChars(srcBegin,srcEnd,dst,dstBegin)
                  @java.lang.String;
      }\>(\forall int i; ( ((i >= 0 & i < (srcEnd-srcBegin))
		    	      -> charAt(srcBegin+i,content(s)) = dst[dstBegin+i])
			     & ((i >= 0 & i < dstBegin)
			       -> dst[i]=dst@pre[i])
			     & ((i >= dstBegin+(srcEnd-srcBegin) & i < dst.length)
			       -> dst[i]=dst@pre[i]) ))
      \modifies { dst }
      \displayname "getChars Normal"
  };

  getCharsExcBounds {
      \programVariables {
          java.lang.String s;
          char[] dst;
          int srcBegin, srcEnd, dstBegin;
      }
      (  dst != null
       & (  srcBegin < 0
          | srcBegin > srcEnd
          | srcEnd > length(content(s))
          | dstBegin < 0 
          | dstBegin+(srcEnd-srcBegin) > dst.length ))
      ->
      \<{
          #catchAll (java.lang.Exception exc) {
              s.getChars(srcBegin,srcEnd,dst,dstBegin)
                      @java.lang.String;
      }}\>( exc != null
          & java.lang.IndexOutOfBoundsException::instance(exc) = TRUE)
      \modifies {java.lang.IndexOutOfBoundsException.<nextToCreate>,
                 \for java.lang.IndexOutOfBoundsException exc; exc.<created>,
                 \for java.lang.IndexOutOfBoundsException exc; exc.<transient>,
                 \for java.lang.IndexOutOfBoundsException exc; exc.<initialized> }
      \displayname "getChars Exceptional"
  };

  getCharsExcNull {
      \programVariables {
          java.lang.String s;
          char[] dst;
          int srcBegin, srcEnd, dstBegin;
      }
      (dst = null) ->
      \<{
          #catchAll (java.lang.Exception exc) {
              s.getChars(srcBegin,srcEnd,dst,dstBegin)
                      @java.lang.String;
      }}\>( exc != null
           & java.lang.NullPointerException::instance(exc) = TRUE)
      \modifies {java.lang.NullPointerException.<nextToCreate>,
                 \for java.lang.NullPointerException exc; exc.<created>,
                 \for java.lang.NullPointerException exc; exc.<transient>,
                 \for java.lang.NullPointerException exc; exc.<initialized> }
      \displayname "getChars NullPointer"
  };

  //
  // toCharArray
  //
  toCharArray {
      \programVariables {
          java.lang.String s;
          char[] result;
      }
      true ->
      \<{
          result = s.toCharArray()@java.lang.String;
      }\>(  result != null
          & result.length = length(content(s))
          & \forall int i; ((i >= 0 & i < length(content(s)))
                       -> charAt(i,content(s)) = result[i])
          & java.lang.Object::<created>@pre(result) = FALSE
          & result.<created>@(java.lang.Object) = TRUE)
      \modifies { result,
                  jchar[].<nextToCreate>,
                  result.<created>@(java.lang.Object),
                  result.<initialized>@(java.lang.Object),
                  result.<transient>@(java.lang.Object) }
      \displayname "toCharArray"
  };

  //
  // valueOf
  //
  valueOfBoolean {
      \programVariables {
          java.lang.String result;
          boolean bVal;
      }
      true ->
      \<{
          result = java.lang.String.valueOf(bVal)@java.lang.String;
      }\>(   content(result) = \if (bVal = TRUE)
                               \then ( cons((jchar)'t',
                                       cons((jchar)'r',
                                       cons((jchar)'u',
                                       cons((jchar)'e',empty)))) )
                               \else ( cons((jchar)'f',
                                       cons((jchar)'a',
                                       cons((jchar)'l',
                                       cons((jchar)'s',
                                       cons((jchar)'e',empty))))) )
          & java.lang.Object::<created>@pre(result) = FALSE
          & result.<created>@(java.lang.Object) = TRUE
          & result != null )
      \modifies { result,
                  content(result),
                  result.<nextToCreate>@(java.lang.String),
                  result.<created>@(java.lang.Object),
                  result.<initialized>@(java.lang.Object),
                  result.<transient>@(java.lang.Object) }
      \displayname "valueOf"
  };

  valueOfChar {
      \programVariables {
          java.lang.String result;
          char charVal;
      }
      true ->
      \<{
      result = java.lang.String.valueOf(charVal)@java.lang.String;
      }\>(   content(result) = cons(charVal,empty)
          & java.lang.Object::<created>@pre(result) = FALSE
          & result.<created>@(java.lang.Object) = TRUE
          & result != null )
      \modifies { result,
                  content(result),
                  result.<nextToCreate>@(java.lang.String),
                  result.<created>@(java.lang.Object),
                  result.<initialized>@(java.lang.Object),
                  result.<transient>@(java.lang.Object) }
      \displayname "valueOf"
  };

  valueOfCharArrayNormal {
      \programVariables {
          java.lang.String result;
          char[] data;
      }
      (data != null) ->
      \<{
          result = java.lang.String.valueOf(data)@java.lang.String;
      }\>(   (\forall int i; ((i >= 0 & i < data.length)
                      -> charAt(i,content(result)) = data[i]))
          & length(content(result)) = data.length
          & java.lang.Object::<created>@pre(result) = FALSE
          & result.<created>@(java.lang.Object) = TRUE
          & result != null )
      \modifies { result,
                  content(result),
                  result.<nextToCreate>@(java.lang.String),
                  result.<created>@(java.lang.Object),
                  result.<initialized>@(java.lang.Object),
                  result.<transient>@(java.lang.Object) }
      \displayname "valueOf"
  };

  valueOfCharArrayExc {
      \programVariables {
          java.lang.String result;
          char[] data;
      }
      (data = null) ->
      \<{
          #catchAll (java.lang.Exception exc) {
             result = java.lang.String.valueOf(data)@java.lang.String;
      }}\>( exc != null
           & java.lang.NullPointerException::instance(exc) = TRUE )
      \modifies {java.lang.NullPointerException.<nextToCreate>,
                 \for java.lang.NullPointerException exc; exc.<created>,
                 \for java.lang.NullPointerException exc; exc.<transient>,
                 \for java.lang.NullPointerException exc; exc.<initialized> }
      \displayname "valueOf NullPointer"
  };

  valueOfInt {
      \programVariables {
          java.lang.String result;
          int i;
      }
      true ->
      \<{
          result = java.lang.String.valueOf(i)@java.lang.String;
      }\>(   content(result) = removeZeros(translateInt(i))
          & java.lang.Object::<created>@pre(result) = FALSE
          & result.<created>@(java.lang.Object) = TRUE
          & result != null )
      \modifies { result,
                  content(result),
                  result.<nextToCreate>@(java.lang.String),
                  result.<created>@(java.lang.Object),
                  result.<initialized>@(java.lang.Object),
                  result.<transient>@(java.lang.Object) }
      \displayname "valueOf"
  };

  valueOfLong {
      \programVariables {
          java.lang.String result;
          long i;
      }
      true ->
      \<{
          result = java.lang.String.valueOf(i)@java.lang.String;
      }\>(   content(result) = removeZeros(translateInt(i))
          & java.lang.Object::<created>@pre(result) = FALSE
          & result.<created>@(java.lang.Object) = TRUE
          & result != null )
      \modifies { result,
                  content(result),
                  result.<nextToCreate>@(java.lang.String),
                  result.<created>@(java.lang.Object),
                  result.<initialized>@(java.lang.Object),
                  result.<transient>@(java.lang.Object) }
      \displayname "valueOf"
  };

  valueOfCharArrayRangeNormal {
      \programVariables {
          java.lang.String result;
          char[] data;
          int offset, count;
      }
      ( data != null & offset >= 0 & count >= 0
       & offset+count <= data.length)
      ->
      \<{
          result = java.lang.String.valueOf(data,offset,count)
                     @java.lang.String;
      }\>(   (\forall int i; ((i >= 0 & i < count)
                        -> charAt(i,content(result)) = data[offset+i]))
          & length(content(result)) = count
          & java.lang.Object::<created>@pre(result) = FALSE
          & result.<created>@(java.lang.Object) = TRUE
          & result != null )
      \modifies { result,
                  content(result),
                  result.<nextToCreate>@(java.lang.String),
                  result.<created>@(java.lang.Object),
                  result.<initialized>@(java.lang.Object),
                  result.<transient>@(java.lang.Object) }
      \displayname "valueOf Normal"
  };

  valueOfCharArrayRangeExcBounds {
      \programVariables {
          java.lang.String result;
          char[] data;
          int offset, count;
      }
      (  data != null
       & (offset < 0 | count < 0 | offset+count > data.length))
      ->
      \<{
          #catchAll (java.lang.Exception exc) {
              result = java.lang.String.valueOf(data,offset,count)
                         @java.lang.String;
      }}\>(  exc != null
           & java.lang.IndexOutOfBoundsException::instance(exc) = TRUE )
      \modifies {java.lang.IndexOutOfBoundsException.<nextToCreate>,
                 \for java.lang.IndexOutOfBoundsException exc; exc.<created>,
                 \for java.lang.IndexOutOfBoundsException exc; exc.<transient>,
                 \for java.lang.IndexOutOfBoundsException exc; exc.<initialized> }
      \displayname "valueOf Exceptional"
  };

  valueOfCharArrayRangeExcNull {
      \programVariables {
          java.lang.String result;
          char[] data;
          int offset, count;
      }
      (data = null) ->
      \<{
          #catchAll (java.lang.Exception exc) {
              result = java.lang.String.valueOf(data,offset,count)
                        @java.lang.String;
      }}\>(  exc != null
           & java.lang.NullPointerException::instance(exc) = TRUE )
      \modifies {java.lang.NullPointerException.<nextToCreate>,
                 \for java.lang.NullPointerException exc; exc.<created>,
                 \for java.lang.NullPointerException exc; exc.<transient>,
                 \for java.lang.NullPointerException exc; exc.<initialized> }
      \displayname "valueOf NullPointer"
  };

  valueOfObjectNull {
      \programVariables {
          java.lang.String result;
          java.lang.Object obj;
      }
      obj = null ->
      \<{
          result = java.lang.String.valueOf(obj)@java.lang.String;
      }\>(   content(result) = cons((jchar)'n',cons((jchar)'u',
                        cons((jchar)'l',cons((jchar)'l',empty))))
          & java.lang.Object::<created>@pre(result) = FALSE
          & result.<created>@(java.lang.Object) = TRUE
          & result != null )
      \modifies { result,
                  content(result),
                  result.<nextToCreate>@(java.lang.String),
                  result.<created>@(java.lang.Object),
                  result.<initialized>@(java.lang.Object),
                  result.<transient>@(java.lang.Object) }
      \displayname "valueOf null"
  };

  valueOfObjectNonNull {
      \programVariables {
          java.lang.String result;
          java.lang.Object obj;
      }
      obj != null ->
      \<{
          result = java.lang.String.valueOf(obj)@java.lang.String;
      }\>( result = obj.toString() )
      \modifies { result }
      \displayname "valueOf non null"
  };
    
  hashCode {
      \programVariables {
          java.lang.String s;
          int result;
      }
      true ->
      \<{
          result = s.hashCode()@java.lang.String;
      }\>(result = hashCode(content(s)))
      \modifies { result }
  };
  
  constrNormal {
      \programVariables {
          java.lang.String s;
      }
      true ->
      \<{
          s.<init>()@java.lang.String;
      }\>(content(s) = empty)
      \modifies { content(s) }
      \displayname "Constructor Normal Execution"
  };

  constrCharArrayNormal {
      \programVariables {
          java.lang.String s;
          char[] v;
      }
      (v != null) ->
      \<{
          s.<init>(v)@java.lang.String;
      }\>(  length(content(s)) = v.length
          & \forall int i; ((i >= 0 & i < v.length)
                       -> charAt(i,content(s)) = v[i]) )
      \modifies { content(s) }
      \displayname "Constructor Normal Execution"
  };

  constrCharArrayExc {
      \programVariables {
          java.lang.String s;
          char[] v;
      }
      (v = null) ->
      \<{
           #catchAll (java.lang.Exception exc) {
               s.<init>(v)@java.lang.String;
      }}\>(  exc != null
           & java.lang.NullPointerException::instance(exc) = TRUE )
      \modifies {java.lang.NullPointerException.<nextToCreate>,
                 \for java.lang.NullPointerException exc; exc.<created>,
                 \for java.lang.NullPointerException exc; exc.<transient>,
                 \for java.lang.NullPointerException exc; exc.<initialized> }
      \displayname "Constructor Exceptional Execution"
  };

  constrCharArrayRangeNormal {
      \programVariables {
          java.lang.String s;
          char[] v;
          int offset, count;
      }
      (  v != null & offset >= 0
       & count >= 0 & offset+count <= v.length) ->
      \<{
          s.<init>(v, offset, count)@java.lang.String;
      }\>(  length(content(s)) = count
          & \forall int i; ((i >= 0 & i < count)
                    -> charAt(i,content(s)) = v[offset+i]) )
      \modifies { content(s) }
      \displayname "Constructor Normal Execution"
  };

  constrCharArrayRangeExcBounds {
      \programVariables {
          java.lang.String s;
          char[] v;
          int offset, count;
      }
      (v != null & (offset < 0 | count < 0 | offset+count > v.length))
      ->
      \<{
          #catchAll(java.lang.Exception exc) {
              s.<init>(v, offset, count)@java.lang.String;
      }}\>(  exc != null
           & java.lang.IndexOutOfBoundsException::instance(exc) = TRUE )
      \modifies {java.lang.IndexOutOfBoundsException.<nextToCreate>,
                 \for java.lang.IndexOutOfBoundsException exc; exc.<created>,
                 \for java.lang.IndexOutOfBoundsException exc; exc.<transient>,
                 \for java.lang.IndexOutOfBoundsException exc; exc.<initialized> }
      \displayname "Constructor Exceptional Execution"
  };

  constrCharArrayRangeExcNull {
      \programVariables {
          java.lang.String s;
          char[] v;
          int offset, count;
      }
      (v = null) ->
      \<{
          #catchAll(java.lang.Exception exc) {
              s.<init>(v, offset, count)@java.lang.String;
      }}\>(  exc != null
           & java.lang.NullPointerException::instance(exc) = TRUE )
	\modifies {java.lang.NullPointerException.<nextToCreate>,
                 \for java.lang.NullPointerException exc; exc.<created>,
                 \for java.lang.NullPointerException exc; exc.<transient>,
                 \for java.lang.NullPointerException exc; exc.<initialized> }
	\displayname "Constructor Exceptional Execution"
  };

  constrCopyNormal {
      \programVariables {
          java.lang.String s, t;
      }
      (t != null) ->
      \<{
          s.<init>(t)@java.lang.String;
      }\>( content(s) = content(t) )
      \modifies { content(s) }
      \displayname "Copy Constructor Normal Execution"
  };

  constrCopyExc {
      \programVariables {
          java.lang.String s, t;
      }
      (t = null) ->
      \<{
          #catchAll(java.lang.Exception exc) {
              s.<init>(t)@java.lang.String;
      }}\>(  exc != null
           & java.lang.NullPointerException::instance(exc) = TRUE )
      \modifies {java.lang.NullPointerException.<nextToCreate>,
                 \for java.lang.NullPointerException exc; exc.<created>,
                 \for java.lang.NullPointerException exc; exc.<transient>,
                 \for java.lang.NullPointerException exc; exc.<initialized> }
      \displayname "Copy Constructor Exceptional Execution"
  };

}

/*
 * Program Rules for Strings
 * - model the execution in absence of the string pool
 */
\rules(stringRules:withoutStringPool) {
    
  //
  // Assignment of a Literal
  //
  stringAssignment  {
      \schemaVar \modalOperator { diamond, box, diamond_trc,
                   box_trc, throughout_trc } #normalassign;
      \schemaVar \program Variable #v;
      \schemaVar \program StringLiteral #slit;
      \schemaVar \formula post;
      
      \find (\modality{#normalassign}{.. #v = #slit; ...}\endmodality(post)) 
      \replacewith ({ #v := java.lang.String::<get>(#v.<nextToCreate>
                                       @(java.lang.String)) }
                    { #v.<nextToCreate>@(java.lang.String) :=
                                    #v.<nextToCreate>@(java.lang.String)+1 ||
                      #v.<created>@(java.lang.Object):=TRUE ||
                      #v.<initialized>@(java.lang.Object):=TRUE ||
                      #v.<transient>@(java.lang.Object):=0 ||
                      content(#v):= #slit}
                    \modality{#normalassign}{.. ...}\endmodality(post)) 
      \heuristics (simplify_prog, simplify_prog_subset)
      \displayname "assignment"
  };

  //
  // The "+" operator
  //
  stringConcat {
      \schemaVar \modalOperator { diamond, box, diamond_trc,
                   box_trc, throughout_trc } #normalassign;
      \schemaVar \program Variable #v;
      \schemaVar \program SimpleStringExpression #sstr1, #sstr2;
      \schemaVar \formula post;

      \find ( \modality{#normalassign}
              {.. #v = #sstr1 + #sstr2; ...}
              \endmodality(post))
      \replacewith ( { #v := java.lang.String::<get>(#v.<nextToCreate>
                                       @(java.lang.String)) }
                     { #v.<nextToCreate>@(java.lang.String) := #v.<nextToCreate>
                                                             @(java.lang.String)+1 ||
                       #v.<created>@(java.lang.Object):=TRUE ||
                       #v.<initialized>@(java.lang.Object):=TRUE ||
                       #v.<transient>@(java.lang.Object):=0 ||
                       content(#v) := concat(content(#sstr1),content(#sstr2)) }
                      \modality{#normalassign}{.. ...}\endmodality(post) )
      \heuristics (simplify_prog, simplify_prog_subset)
      \displayname "concatenation"
  };
}

/*
 * Program Rules for Strings
 * - model the execution in absence of the string pool
 */
\rules(stringRules:withStringPool) {
    
  //
  // Assignment of a Literal
  //
  stringAssignment  {
      \schemaVar \modalOperator { diamond, box, diamond_trc,
                   box_trc, throughout_trc } #normalassign;
      \schemaVar \program Variable #v;
      \schemaVar \program StringLiteral #slit;
      \schemaVar \formula post;
      
      \find (\modality{#normalassign}{.. #v = #slit; ...}\endmodality(post)) 
      \replacewith ({ #v := pool(#slit) || content(pool(#slit)) := #slit}
                    \modality{#normalassign}{.. ...}\endmodality(post)) 
      \heuristics (simplify_prog, simplify_prog_subset)
      \displayname "assignment"
  };

  poolKeyIsContentOfValue {
  	\schemaVar \term CharList slit;
	\assumes(inReachableState ==>)
  	\find (content(pool(slit))) 
  	\sameUpdateLevel
  	\replacewith(\if (pool(slit) != null) \then (slit) \else (content(pool(slit))))
  };

  poolNullOrCreated {
  	\schemaVar \term CharList slit;
	\assumes(inReachableState ==>)
  	\find (pool(slit))
  	\sameUpdateLevel
  	\add(pool(slit) = null | pool(slit).<created>@(java.lang.Object) = TRUE ==>)
  };
  
  //
  // The "+" operator
  //
  stringConcat {
      \schemaVar \modalOperator { diamond, box, diamond_trc,
                   box_trc, throughout_trc } #normalassign;
      \schemaVar \program Variable #v;
      \schemaVar \program SimpleStringExpression #sstr1, #sstr2;
      \schemaVar \formula post;

      \find ( \modality{#normalassign}
              {.. #v = #sstr1 + #sstr2; ...}
              \endmodality(post))
      \replacewith ( { #v := java.lang.String::<get>(#v.<nextToCreate>
                                       @(java.lang.String)) }
                     { #v.<nextToCreate>@(java.lang.String) := #v.<nextToCreate>
                                                             @(java.lang.String)+1 ||
                       #v.<created>@(java.lang.Object):=TRUE ||
                       #v.<initialized>@(java.lang.Object):=TRUE ||
                       #v.<transient>@(java.lang.Object):=0 ||
                       content(#v) := concat(content(#sstr1),content(#sstr2)) }
                      \modality{#normalassign}{.. ...}\endmodality(post) )
      \heuristics (simplify_prog, simplify_prog_subset)
      \displayname "concatenation"
  };
}
